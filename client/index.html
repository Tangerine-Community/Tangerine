
<!doctype html>
<!-- foo -->

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Tangerine v3</title>
  <meta name="description" content="Tangerine v3">
  <meta name="author" content="Tangerine">
</head>

<body>

<a href="/tangerine/en/index.html" onclick="setLocale('en')">Go to app</a>

<script>

window.didOnce = false
document.onreadystatechange = function () {
  if (document.readyState !== "interactive") {
    return
  }
  if (window.didOnce === true) {
    return
  }
  window.didOnce = true
  go()
}
// Foo bar ya.
//  if (window.location.href.lastIndexOf('update=true')) {

async function go() {
  console.log('go')
  // @TODO This fetch will fail when offline. handle gracefully.
  let response = await fetch('release-uuid.txt')
  window.currentReleaseUuid = (await response.text()).replace(/\n|\r/g, "")
  window.storedReleaseUuid = localStorage.getItem('release-uuid')
  if (!window.storedReleaseUuid) {
    let confirmation = confirm('Would you like to install this app for offline use?')
    window.installReleaseUuid = window.currentReleaseUuid
    if (confirmation) {
      updateServiceWorker()
    } else {
      navigateAway()
    }
  }
  else if (window.storedReleaseUuid !== window.currentReleaseUuid) {
    alert('Checking for updates.')
    let confirmation = confirm('There is an update available. Would you like to update?')
    window.installReleaseUuid = window.currentReleaseUuid
    if (confirmation) {
      updateServiceWorker()
    } else {
      navigateAway()
    }
  } else {
    alert('No updates found.')
  }
} 

function navigateAway() {
  if (document.readyState === 'interactive') {
      navigateToLocale()
  }
  function navigateToLocale() {
    let locale = localStorage.getItem("tangy-locale");
    if(locale){
      window.location.href = 'tangerine/' +locale;
    } 
  }
  function setLocale(locale) {
    localStorage.setItem("tangy-locale", locale);
  }
}

function updateServiceWorker() {
  navigator.serviceWorker.register('/' + window.installReleaseUuid + '.js').then(function (registration) {
      // Registration was successful
      console.log('ServiceWorker registration successful with scope: ', registration.scope);
      if (registration.installing) {
        console.log('registration.installing is available on service worker registration.')
      }
      // updatefound is fired if service-worker.js changes.
      registration.onupdatefound = function () {
        console.log('This app is installing.')
        alert('This app is installing.')
        // The updatefound event implies that registration.installing is set; see
        // https://slightlyoff.github.io/ServiceWorker/spec/service_worker/index.html#service-worker-container-updatefound-event
        var installingWorker = registration.installing;
        installingWorker.onstatechange = function () {
          // @TODO look for state of caching progress, show to user.
          switch (installingWorker.state) {
            case 'installed':
              if (navigator.serviceWorker.controller) {
                // At this point, the old content will have been purged and the fresh content will
                // have been added to the cache.
                // It's the perfect time to display a "New content is available; please refresh."
                // message in the page's interface.
                localStorage.setItem('release-uuid', window.installReleaseUuid)
                console.log('Your app has been updated. Reloading now.');
                alert('Your app has been updated. Reloading now.');
                // If URL has a hash, we have to carve it out less there will be no reload.
                window.location = window.location.href.replace('\/\#', '');
                /* TODO: Support for reloading when app is not in the TLDR's root.
                    TODO: Prompt user wether or not they wanted to update the cache in the first place.. 
                    TODO: Prompt user wether or not they want to reload. 
                if (window.location.href.indexOf('\/\#') !== -1) {
                  window.location = window.location.href;
                } else {
                  window.location = window.location.href.substr(0, window.location.href.indexOf('\/\#'))
                }
                */
              } else {
                // At this point, everything has been precached, but the service worker is not
                // controlling the page. The service worker will not take control until the next
                // reload or navigation to a page under the registered scope.
                // It's the perfect time to display a "Content is cached for offline use." message.
                console.log('This App has been installed and is now ready for offline use.');
                debugger
                localStorage.setItem('release-uuid', window.installReleaseUuid)
                alert('This App has been installed and is now ready for offline use.');
                window.location = window.location.href.replace('\/\#', '');
              }
              break;
            case 'redundant':
              console.error('The installing service worker became redundant.');
              break;
          }
        };
      };
    }).catch(function (err) {
      // registration failed :(
      console.log('ServiceWorker registration failed: ', err);
      alert('Update failed: ', err);
    });
  }
  </script>
</body>
</html>
