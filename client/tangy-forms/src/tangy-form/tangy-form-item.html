<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">

<style>
  paper-input {
    margin-bottom: 15px;
  }
  paper-radio-button {
    margin: 0px 15px 0px 0px;
  }
</style>
   
<dom-module id="tangy-form-item">
  
  <template>
    <style>
      :host {
        padding: 15px;
        min-height: 100vh;
      }
      paper-input {
        margin-bottom: 15px;
      }
      :host paper-card {
        -webkit-transition: .4s;
        -moz-transition: .4s;
        -ms-transition: .4s;
        -o-transition: .4s;
        display: block;
        --paper-card-background-color: #FFF;
        --paper-card-header-color: #8BC34A;
        max-width: 325px;
        margin: 30px auto;
      }
      :host([disabled]) paper-card {
        --paper-card-background-color: gray !important;
        --paper-card-header-color: #CCC;
      }
      :host([open]) paper-card {
        -webkit-transition: .4s;
        -moz-transition: .4s;
        -ms-transition: .4s;
        -o-transition: .4s;
        display: block;
        max-width: 720px;
        margin: 30px auto;
        --paper-card-background-color: #FFF !important;
        --paper-card-header-color: #8BC34A;
        color: #000;
      }
      :host([open]) #open {
        display: none;
      }
      :host(:not([open])) #close {
        display: none;
      }
      :host([disabled]) #open {
        display: none;
      }
      :host([no-buttons]) #open,
      :host([no-buttons]) #close {
        display: none;
      }
      .card-actions {
        height: 45px;
      }
      paper-button {
        background: #FF9800;
        --paper-button-ink-color: #FFF;
        color: #FFF;
      }
    </style>
    <paper-card id="card" class="shrunk" heading="[[title]]">
      <div class="card-content">
        <slot></slot>
      </div>
      <div class="card-actions">
        <paper-button id="open">open</paper-button>
        <paper-button id="close">submit</paper-button>
        <template is="dom-if" if="{{valid}}">
            <iron-icon style="color: #8BC34A; float: right; margin-top:10px" icon="icons:check-circle"></iron-icon>
        </template>
      </div>
    </paper-card>
  </template>

  <script>
    /**
     * `tangy-form-item`
     * An element used to encapsulate form elements for multipage forms with a response in PouchDB.
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class TangyFormItem extends Polymer.Element {

      static get is() { return 'tangy-form-item'; }
      static get properties() {
        return {
          src: {
            type: String,
            value: 'tangy-form-item',
            reflectToAttribute: true
          },
          title: {
            type: String,
            value: '',
            reflectToAttribute: true
          },
          noButtons: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          // State
          open: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            observer: 'onOpenChange',
          },
          valid: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          stuck: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          },
          disabled: {
            type: Boolean,
            value: false,
            reflectToAttribute: true
          }
          
        };
      }

      async connectedCallback() {
        super.connectedCallback()
        this.store = window.tangyFormStore
        this.$.close.addEventListener('click', () => this.store.dispatch({type: ITEM_CLOSE, itemId: this.id }))
        this.$.open.addEventListener('click', () => this.store.dispatch({ type: ITEM_OPEN, itemId: this.id }))
        this.addEventListener('change', (event) => this.store.dispatch({type: INPUT_VALUE_CHANGE,  inputName: event.target.name, inputValue: event.target.value} ))
        this.addEventListener('change', (event) => this.dispatchEvent(new CustomEvent('INPUT_VALUE_CHANGE') ))
      }

      async onOpenChange(open) {
        if (open === false && this.innerHTML !== '') {
          if (this.validate()) {
            this.innerHTML = '' 
            this.store.dispatch({type: ITEM_VALID, itemId: this.id })
          } else {
            this.store.dispatch({type: ITEM_CLOSE_STUCK, itemId: this.id })
          }
        }
        // Open it, but only if empty because we might be stuck.
        if (open == true && this.innerHTML == '') {
          let request = await fetch(this.src)
          this.innerHTML = await request.text()
          this.querySelectorAll('[name]').forEach((input) => {
            this.store.dispatch({type: 'INPUT_ADDED', attributes: serializeElement(input)})
          })
        }
      }

      validate() {
        let inputs = this.querySelectorAll('[name]')
        let invalidInputNames = [] 
        inputs.forEach((input) => {
          if (!input.validate()) invalidInputNames.push(input.name)
        })
        if (invalidInputNames.length > 0) {
          return false
        } else {
          return true
        }
      }


    }

    window.customElements.define(TangyFormItem.is, TangyFormItem);

  </script>
</dom-module>
