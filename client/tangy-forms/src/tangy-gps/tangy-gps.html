<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="tangy-gps">
  <template>
    <style>
      :host {
        display: block;
      }
      :host([required]:not([disabled])) label::before  { 
        content: "*"; 
        color: red; 
        position: absolute;
        top: 4px;
        right: 5px;
      }
    </style>
    <div>
      <b>Current Position</b>
      <div>
        Latitude: {{currentLatitude}} <br> Longitude: {{currentLongitude}}
      </div>
      <b>Recorded Position</b>
      <div>
        Latitude: {{recordedLatitude}} <br> Longitude: {{recordedLongitude}}
      </div>
      <paper-button raised on-click="clickedRecord">record position</paper-button>
      <slot></slot>
    </div>
  </template>

  <script>
    /**
     * `tangy-timed`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class TangyGps extends Polymer.Element {
      static get is() { return 'tangy-gps'; }
      static get properties() {
        return {
          name: {
            type: String,
            value: 'tangy-gps' 
          },
          value: {
            type: Object,
            value: {},
            observer: 'reflect',
            reflectToAttribute: true
          }
        };
      }

      // Element class can define custom element reactions
      // @TODO: Duplicating ready?
      connectedCallback() {
        super.connectedCallback();
      }
    
      ready() {
        super.ready();
        this.currentLatitude = 'Searching...'
        this.currentLongitude = 'Searching...'
        // window.gpsPosition may already be watched from another location. Allow for that.
        if (!window.gpsPosition) {
          navigator.geolocation.watchPosition((position) => {
            window.gpsPosition = {
              latitude: position.coords.latitude, 
              longitude: position.coords.longitude
            }
            this.updateWatchedPosition()
          })
        } else {
          this.updateWatchedPosition()
        }
      }

      updateWatchedPosition() {
        setInterval(() => {
          this.currentLatitude = window.gpsPosition.latitude
          this.currentLongitude = window.gpsPosition.longitude
        }, 2000)
      }

      reflect() {
        this.recordedLatitude = this.value.recordedLatitude
        this.recordedLongitude = this.value.recordedLongitude
      }

      clickedRecord() {
        this.dispatchEvent(new CustomEvent('INPUT_VALUE_CHANGE', {bubbles: true, detail: {
          inputName: this.name,
          inputValue: {
            recordedLatitude: this.currentLatitude,
            recordedLongitude: this.currentLongitude,
          },
          inputIncomplete: false,
          inputInvalid: false 
        }}))
      }
    
    }

    window.customElements.define(TangyGps.is, TangyGps);
  </script>
</dom-module>
