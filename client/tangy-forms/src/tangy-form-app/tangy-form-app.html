<link rel="import" href="../tangy-form/tangy-form.html">
<link rel="import" href="../tangy-form/tangy-form-item.html">

<!-- dependencies -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<script src="../../bower_components/pouchdb/dist/pouchdb.js"></script>

<dom-module id="tangy-form-app">
  <style>
    body {
      background: #F4F4F4;
      padding: 0px;
      margin: 0px;
      scroll-behavior: smooth; 
    }
  </style>

  <template>
    <style>
      :host {
        display: block;
      }
      .form-link {
        background: #FF9800;
        padding: 15px;
        margin: 15px;
      }
      paper-card {
        border: 1px solid #FF9800;
        --paper-card-header-color: #fff !important;
      }
      paper-card:hover {
        border: 1px solid #8BC34A;
      }
      paper-card .card-actions {
        text-align: right;
        color: #fff;
      }
      .launch-form {
        position: relative;
        left: 45px;
        top: 8px;
      }
      #form-view--nav {
        font-weight: heavy;
        font-size: 1.2em;
        padding: 15px;
        color: #FFF;
        background: #FF9800;
      }
    </style>
    <div class="tangy-form-app--container">
      <div id="form-list">
        <template is="dom-repeat" items="{{forms}}">
            <paper-card 
              class="form-link" 
              image="images/noun_1018421_cc-small.png" 
              alt="[[item.title]]" 
              heading="[[item.title]]">
                <div class="card-actions">
                  <a href="?form=/content/[[item.src]]">
                    <paper-button class="launch-form">
                      <iron-icon icon="icons:launch"/>
                    </paper-button>
                  </a>
                </div>
            </paper-card>
        </template>
      </div>
      <div id="form-view" hidden>
        <div id="form-view--nav">
          <a href="/tangy-forms/index.html"><iron-icon icon="icons:close"></iron-icon></a>
          [[formTitle]]
        </div>
        <slot></slot>
      </div>
    </div>

  </template>

  <script>
    /**
     * `tangy-form-app`
     * ... 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */

    class TangyFormApp extends Polymer.Element {

      static get is() { return 'tangy-form-app'; }

      static get properties() {
        return {
          database: {
            type: String,
            value: 'tangy-form'
          },
          forms: {
            type: Array,
            value: []
          },
          formSrc: {
            type: String,
            value: '',
            observer: 'onFormSrcChange'
          }
        };
      }
      
      connectedCallback() {
        super.connectedCallback(); 
        let query = this.parseQuery(window.location.search)
        if (query.form) {
          this.showForm(query.form)
        } else {
          this.showFormsList()
        }
      }

			// For parsing window.location.search parameters.
      parseQuery(qstr) {
        var query = {};
        var a = (qstr[0] === '?' ? qstr.substr(1) : qstr).split('&');
        for (var i = 0; i < a.length; i++) {
          var b = a[i].split('=');
          query[decodeURIComponent(b[0])] = decodeURIComponent(b[1] || '');
        }
        return query;
      }
      async showFormsList() {
        this.$['form-view'].hidden = true
        this.$['form-list'].hidden = false
        // Load forms list.
        let formsJson = await fetch('../content/forms.json')
        this.forms = await formsJson.json() 
      }

      onFormSrcChange(newValue, oldValue) {
        if (newValue !== '') this.showForm(newValue)
      }

      async showFormListener(event) {
        window.location.hash = event.currentTarget.dataFormSrc
        this.formSrc = event.currentTarget.dataFormSrc
      }

      async showForm(formSrc) {
        let query = this.parseQuery(window.location.search)
        this.$['form-view'].hidden = false
        this.$['form-list'].hidden = true 
        // Load the form into the DOM.
        let formHtml = await fetch(formSrc)
        // Put the formHtml in a template first so element do not initialize connectedCallback
        // before we modify them.
        let formTemplate = document.createElement('template')
        formTemplate.innerHTML = await formHtml.text()
        let formEl = formTemplate.content.querySelector('tangy-form')
        if (query.database) formEl.database = query.database
        if (query['linear-mode']) formEl.setAttribute('linearMode', true) 
        if (query['response-id']) formEl.setAttribute('responseId', query['response-id'])
        if (query['hide-closed-items']) formEl.setAttribute('hide-closed-items', true) 
        if (query['hide-nav']) formEl.setAttribute('hide-nav', true) 
        if (query['hide-responses']) formEl.setAttribute('hide-responses', true) 
        this.innerHTML = formTemplate.innerHTML 
        debugger
      }

    }

    window.customElements.define(TangyFormApp.is, TangyFormApp);
  </script>
</dom-module>
